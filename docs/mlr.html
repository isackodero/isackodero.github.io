
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>System Design: Stripe Capture the Flag</title>
  <script>(function(d) {var config = {kitId: 'all7jvn',scriptTimeout: 1000,async: true},h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)})(document);</script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="https://lightning.svbtle.com/cargo/favicon-3686f5990e669ad2a1684f0ac250c4d9ddc03e2ef6f3c980f17b7aae786833ef.ico">
  <link rel="icon" sizes="196x196" href="https://lightning.svbtle.com/cargo/apple-touch-icon-8ed2bd858a30400ead0535543ffb8ad2ab3e036a2f0adb797dc641458d00a41a.png">
  <link rel="mask-icon" href="https://lightning.svbtle.com/cargo/default-b7e7b5361ab4c50a9ceb6dc296e0f157e2ec9c2f2c6f30832d991dc361d69512.svg" color="black">
  <meta name="generator" content="Svbtle.com" />
  <meta name="description" content="We launched Stripe CTF 2.0 on Wednesday. Thus far we’ve had 14,000 signups, and over 500 people have captured the flag. Designing an architecture to handle this many users, all running their potentially malicious code on the level servers, was... | Greg Brockman | Svbtle"/>
  <link rel="canonical" href="https://blog.gregbrockman.com/system-design-stripe-capture-the-flag" />
  <meta property="og:url" content="https://blog.gregbrockman.com/system-design-stripe-capture-the-flag" />
  <meta property="twitter:site" content="@svbtle" />
  <meta property="twitter:title" content="System Design: Stripe Capture the Flag" />
  <meta property="twitter:description" content="We launched Stripe CTF 2.0 on Wednesday. Thus far we’ve had 14,000 signups, and over 500 people have captured the flag. Designing an architecture to handle this many users, all running their potentially malicious code on the level servers, was..." />
  <meta property="twitter:creator" content="@gdb" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:image" content="https://lightning.svbtle.com/cargo/icons/svbtle_logo-ba4b41e5249a7e3f19288fa586ea973569bfb83452114886be65bc5d8eb13b21.png" />
  <meta property="twitter:domain" content="https://blog.gregbrockman.com" />
  <meta property="og:title" content="System Design: Stripe Capture the Flag &bull; Greg Brockman" />
  <meta property="og:type" content="article" />
  <meta property="og:description" content="We launched Stripe CTF 2.0 on Wednesday. Thus far we’ve had 14,000 signups, and over 500 people have captured the flag. Designing an architecture to handle this many users, all running their potentially malicious code on the level servers, was... | Greg Brockman | Svbtle" />
  <meta property="og:image" content="https://lightning.svbtle.com/cargo/icons/svbtle_logo-ba4b41e5249a7e3f19288fa586ea973569bfb83452114886be65bc5d8eb13b21.png" />
  <meta property="og:site_name" content="Greg Brockman on Svbtle" />
  <meta property="fb:app_id" content="346346195413177" />
  <link rel="alternate" type="application/rss+xml" href="https://blog.gregbrockman.com/feed" />
  <link rel="stylesheet" href="https://lightning.svbtle.com/cargo/legacy/build.blog-120c367e4cc2cdf2d031c71f795ecea0ef4033f8b24d12d8e147c86e08e2ed2a.css" media="all" data-turbolinks-track="reload" />
  <script src="https://lightning.svbtle.com/cargo/build.blog-41a284c81b4230cd8ab812d35fabef8cc99e927407ed15604d3206997ef79818.js" data-turbolinks-track="reload"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VGMRYDBB5R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('set', 'linker', {
    'accept_incoming': true
  });
  gtag('config', 'G-VGMRYDBB5R');
  gtag('config', 'UA-26652609-2');
</script>  <script src="https://lightning.svbtle.com/cargo/share_buttons-dd547cdb8c37c1c5b949d9a5f034ef854d39634831852762b3d730f59a9e47d4.js" data-turbolinks-track="true"></script>
  <script src="//platform.twitter.com/widgets.js" async></script>
</head>
<body class="overlord blog">
<style scoped>
figure#user_logo a,
figure#user_foot a,
figure.avatar a,
nav#overlord.user_top figure#logo_top a,
figure.kudo.complete div.filling {
  background-image: url('https://lightning.svbtle.com/cargo/blank-3dc89b51de1fd0e237e0320a05be98fb1f11cc04dcf200934ba8a64deec81ffd.png')
}

figure.kudo.activated div.filling,
figure.kudo.complete div.filling {
  background-color: #000000;
}

figure.kudo.activated a,
figure.kudo.complete a {
  border-color: #000000;
}

blockquote,
a blockquote,
div#readnext:hover span.flank_title,
div#foot_more:hover a,
div#foot_userbar a#bottom_tagline span:hover,
article.linked h1.article_title a:hover,
a.continue_button:hover,
article p a:hover,
ul#lightning_drop,
figure#user_foot,
ul#user_links li a:hover,
ul#foot_links li a:hover,
a.buttonize:hover,
button.buttonize:hover,
a.buttonize.outline:hover,
button.buttonize.outline:hover,
nav.pagination span.next a:hover,
nav.pagination span.prev a:hover,
section#readnext:hover p span,
nav#overlord.user_top figure#logo_top {
  border-color: #000000;
}
/*figure#user_logo,*/

figure.avatar,
nav#overlord.user_top figure#logo_top a,
ul#user_links li a:hover,
ul#foot_links li a:hover,
a.buttonize:hover,
button.buttonize:hover,
a.buttonize.outline:hover,
button.buttonize.outline:hover,
nav.pagination span.next a:hover,
nav.pagination span.prev a:hover,
figure#user_logo a,
figure#user_foot a  {
	background-color: #000000;
}

h6.separator_title.read_first,
header#user_top h2 a,
footer#blog_foot h5 a,
article.post h1 a:hover,
div.preview strong,
nav#overlord h2#nav_title.user_top a,
section#readnext:hover h3,
section#readnext:hover p span {
  color: #000000;
}

@keyframes titlePulse
  {
  0% {
    color: #000000;
  }
  50% {
    color: #000000;
  }
  100% {
    color: #000000;
  }
}

@-moz-keyframes titlePulse
  {
  0% {
    color: #000000;
  }
  50% {
    color: #000000;
  }
  100% {
    color: #000000;
  }
}

@-webkit-keyframes titlePulse
  {
  0% {
    color: #000000;
  }
  50% {
    color: #000000;
  }
  100% {
    color: #000000;
  }
}


</style>

<figure id="loading">&nbsp;</figure>
<nav id="overlord" class="user_top">
  <div id="lockup" class="">
    <figure id="logo_top" class=" user_top">
      <a href="/">Svbtle</a>
    </figure>
    <h2 id="nav_title" class="user_top"><a href="https://blog.gregbrockman.com">Greg Brockman</a></h2>
  </div>
  <figure id="hamburger">
    <a href="#menu" id="hamburger_button">Menu</a>
  </figure>
  <ul id="dropdown" class="onblog">
    <li class="dropdown_message">
     <a href="https://svbtle.com">Greg Brockman is writing on the <span class="logoize">Svbtle</span> network.</a>
    </li>
    <li><a href="https://gregbrockman.com"  target="_blank">gregbrockman.com</a></li>
    <li><a href="https://x.com/gdb" class="xdotcom" target="_blank">@gdb</a></li>
    <li><a href="/feed">rss feed</a></li>
    <li style="margin: 0; padding: 0;"><hr class="overlord_nav" /></li>
    <li><a href="https://svbtle.com/about">about svbtle</a></li>
    <li><a href="https://svbtle.com/signup">sign up</a></li>
  </ul>
</nav>
<div id="whiteout"></div>

<section id="container" class="blog user_post">
  <article id="fJ3z8eoyReCrd7LiyvUupK" class="post  historical">
	<time datetime="2012-08-27" class="article_time">August 27, 2012</time>
  <h1 class="article_title">
    <a href="https://blog.gregbrockman.com/system-design-stripe-capture-the-flag">System Design: Stripe Capture the Flag</a>
  </h1>
	<p>We launched <a href="https://stripe.com/blog/capture-the-flag-20">Stripe CTF 2.0</a> on Wednesday. Thus far we’ve had 14,000 signups, and over 500 people have <a href="https://stripe-ctf.com/leaderboard">captured the flag</a>. Designing an architecture to handle this many users, all running their potentially malicious code on the level servers, was definitely a challenge, but it was also a ton of fun.</p>

<p>Our first and foremost design goal was pretty simple: don’t let people root the machines. It’s horrendously difficult to keep a shared Linux login machine secure, so the best you can do is apply all of the security countermeasures you can think of. Each level server is configured in the same way (maintaining multiple configurations is a great way to end up with an oversight due to increased complexity). All user-facing services run in a <a href="http://en.wikipedia.org/wiki/Chroot">chroot</a> with only <code>/home</code>, <code>/tmp</code>, <code>/var/tmp</code>, and <code>/var/log</code> writeable. This is implemented by mounting a filesystem (created using <a href="http://wiki.debian.org/Debootstrap">debootstrap</a>) at <code>/var/chroot</code> and <a href="http://docs.1h.com/Bind_mounts">bind-mounting</a> it read-only to <code>/var/chroot-ro</code>. That way a user in the chroot can’t clobber system files even with escalated privileges (thus cutting off many vectors to obtaining a root shell), but we can perform maintenance from outside the chroot. We didn’t mount <code>/proc</code> in the chroot (except where needed to make other software work, and even there we mounted read-only or even <code>chmod</code>‘d 700), and we set <code>/var/log</code> in the chroot to be only accessible to admins. We also went and removed the setuid bit from all binaries (<code>find / -perm -4000</code> is a handy command to find them).</p>

<p>Our second design goal was isolation. Malicious users should not be able to affect gameplay for others. We hadn’t really expected our first CTF to take off, and hence had explicitly decided to punt on user isolation features. As a result, people kept fork-bombing and preventing others from accessing the levels. We spent the week getting very good at clearing out forkbombs (which is a skill I hope never to employ again). This time, we decided to run every end user’s code as a separate UNIX user, meaning that we could use Linux’s native per-user resource limits. (We also considered using <a href="http://lxc.sourceforge.net/">LXC</a>, but didn’t have enough data about its scaling properties — we were also hesitant to have a security-critical component of our system be one that we didn’t know intimately.) Since everything was running as its own user, we needed to spawn server processes on demand — <a href="http://httpd.apache.org/mod_fcgid/">mod_fcgid</a> + <a href="http://httpd.apache.org/docs/2.2/suexec.html">suEXEC</a> provide exactly this feature (we also threw in <a href="http://www.suphp.org/Home.html">suPHP</a> to make the PHP levels more intuitive to people, though I would have preferred running everything under a single setuid wrapper). I wrote a quick <a href="https://github.com/gdb/ctf-helpers/blob/master/src/suexec-wrapper.c">wrapper script</a> around suEXEC to set <a href="http://linux.die.net/man/2/setrlimit">resource limits</a> and <a href="http://en.wikipedia.org/wiki/Nice_(Unix)">nice</a> the child FCGI processes, which would be inherited by any children processes they might spawn. We also set low disk quotas per user and removed unneeded device nodes (e.g. <code>/dev/ram*</code>).</p>

<p>We used the following <code>mod_fcgid</code> config to make sure that users weren’t allocated too many processes (<code>FcgidMaxProcessesPerClass</code>) and that processes were eventually killed off (<code>FcgidMinProcessesPerClass</code>). The <code>FcgidMaxProcesses</code> setting turned out to be useless, as there’s a compile-time constant <code>FCGID_MAX_APPLICATION</code> (set to 1024 on Ubuntu) which dictates a hard limit, and we didn’t want to recompile <code>mod_fcgid</code> by hand.</p>

<pre><code class="prettyprint">FcgidMinProcessesPerClass 0
FcgidMaxProcessesPerClass 2
FcgidMaxProcesses 5000
FcgidProcessLifeTime 150
</code></pre>

<p>The initial CTF level was written in <a href="http://nodejs.org/">node</a>, and hence we were stuck with the problem of trying to run node under FCGI (which as far as I can tell no one has actually done before). As a giant hack, I wrote a <a href="https://github.com/gdb/ctf-helpers/blob/master/bin/fcgi-shim">FCGI shim</a> which translates the FCGI protocol back to HTTP (I’ll go over the details in another blog post). The shim then spawns the node process directly and speaks HTTP to it over a <a href="http://en.wikipedia.org/wiki/Unix_domain_socket">UNIX socket</a>. We also used the shim in a later level to spawn a cluster of server processes on-demand — it turned out to be a pretty flexible approach for getting the process management benefits of mod_fcgid without actually having to speak FCGI.</p>

<p>A couple of levels required us to run a simulated browser so people could exploit XSS bugs. For those levels, we ran a <a href="http://phantomjs.org/">PhantomJS</a> script every few minutes. To make sure it only ran when needed (and that it ran as your assigned UNIX user, in case of Webkit vulnerabilities), we spawned the headless Webkit instance directly from the FCGI dispatcher, using the following code:</p>

<pre><code class="prettyprint lang-ruby">Thread.abort_on_exception = true
Thread.new do
  while true
    started = Time.now

    pid = fork do
      cmd = File.join(File.dirname(__FILE__), '../browser-runner.sh')
      exec([cmd, cmd])
    end
    Process.wait(pid)
    status = $?.exitstatus
    $stderr.puts "Exited with status #{$?}" unless status == 0

    sleep(60 * (3 * rand + 1))
  end
end
</code></pre>

<p>Giving UNIX users random names (and using <a href="http://httpd.apache.org/docs/2.2/mod/mod_userdir.html">mod_userdir</a> as a routing layer) served as a convenient access-control mechanism. We assigned CTF solvers a level URL such as <a href="https://level01-2.stripe-ctf.com/user-iqrncaxifi"></a><a href="https://level01-2.stripe-ctf.com/user-iqrncaxifi">https://level01-2.stripe-ctf.com/user-iqrncaxifi</a>, which was backed by a UNIX user with name <code>user-iqrncaxifi</code>. To prevent people from discovering other users, we set permissions on <code>/etc/passwd</code> and <code>/etc/group</code> to <code>600</code>. It turns out that this makes some software a bit sad (e.g. bash can’t fill in the username in your shell prompt, and Python can’t load the site module), but for the most part those can be worked around.</p>

<p>One issue with the UNIX user approach is actually creating the accounts. It turns out that <code>adduser</code> by default does a linear scan through all possible user IDs, and effectively grinds to a halt once you have lots of users on a system. If you pass it a <code>uid</code> and <code>gid</code> directly, it runs in about 500ms, which still isn’t fast enough for on-demand allocation. Hence we maintained a central database of UNIX users and preallocated 1000 users per box.</p>

<p>We added a variety of other controls. For example, we firewalled off outbound network access on all servers (don’t want people using them to send spam). We also ran our machines such that even if they were completely compromised, we wouldn’t have to care. Hence we ran the CTF on a throwaway domain (stripe-ctf.com) with a fresh SSL cert generated just for the contest.</p>

<p>All told, building CTF was probably about two or three weeks of my time, plus as much time from a combination of other people (props to <a href="https://github.com/abrody">Andy</a>, <a href="https://github.com/siddarth">Sidd</a>, <a href="http://dribbble.com/luddep">Ludwig</a>, <a href="https://github.com/andrew-d">Andrew</a>, and <a href="https://github.com/colinmarc">Colin</a> for doing an awesome job on this). We’ll be publicly posting the levels after the contest is over, so you should check those out. There are a ton of other details on the infrastructure I could delve into; let me know if there’s anything else you’re wondering about!</p>

  <figure class="postend kudo able clearfix" id="kudo_fJ3z8eoyReCrd7LiyvUupK">
    <a href="#kudo">
      <div class="filling">&nbsp;</div>
    </a>
    <div class="num">66</div>
    <div class="txt">Kudos</div>
  </figure>
  <figure class="side kudo able clearfix" id="kudo_side_fJ3z8eoyReCrd7LiyvUupK">
    <a href="#kudo">
      <div class="filling">&nbsp;</div>
    </a>
    <div class="num">66</div>
    <div class="txt">Kudos</div>
  </figure>
</article>

  <div id="share_links" data-no-turbolink>
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="gdb" data-related="svbtle" data-no-turbolink>Tweet</a>
    <div style="margin-top: 4px; margin-bottom: 8px; margin-left: 0px; display: block;" class="fb-share-button" data-href="https://blog.gregbrockman.com/system-design-stripe-capture-the-flag" data-layout="button_count" data-no-turbolink></div>
  <div>
</section>
<section id="readnext">
  <a href="https://blog.gregbrockman.com/how-i-became-a-machine-learning-practitioner">
    <h4 class="readnext_header">Now read this</h4>
    <h3 class="readnext_title">How I became a machine learning practitioner</h3>
    <p class="readnext_content">For the first three years of OpenAI, I dreamed of becoming a machine learning expert but made little progress towards that goal. Over the past nine months, I’ve finally made the transition to being a machine learning practitioner. It was... <span class="continue_btn">Continue&nbsp;&rarr;</span></p>
  </a>
</section>
<footer id="blog_foot" class="cf">
  <ul id="foot_links">
    <li><a href="https://x.com/gdb">@gdb</a></li>
    <li><a href="https://gregbrockman.com" >gregbrockman.com</a></li>
  </ul>
  <figure id="user_foot"><a href="/">Svbtle</a></figure>
  <h5><a href="https://blog.gregbrockman.com">Greg Brockman</a></h5>
</footer>
<footer id="foot">
  <figure id="logo_foot"><a href="https://svbtle.com">Svbtle</a></figure>
  <a href="https://svbtle.com/terms" style="color: #ccc; margin-left: 25px;">Terms</a> <span style="color: #ccc;">•</span> <a href="https://svbtle.com/privacy" style="color: #ccc;">Privacy</a>
  <span style="color: #ccc;">•</span> <a href="https://svbtle.com/promise" style="color: #ccc; margin-right: 15px;">Promise</a>
  <br/><br/>
</footer>

<div id="lights">&nbsp;</div>
<div id="app-data" data-name="svbtle" data-version="8.5-legible" data-magicNum="2572031820.15"></div><div id="px-data" data-ax="posts" data-sx="show"></div><div id="user-data" data-here="false" data-state="logged-out"></div><div id="blog-data" data-title="Greg Brockman" data-blogname="gdb" data-extid="8SMTiky8WK9x16AjSma1Vx" data-color="000000" data-color-rgb="0,0,0" data-color-rgba="(0,0,0,0.5)" data-blog-tracker="UA-26652609-2"></div></body>
</html>